# Ограничение одновременных загрузок

## Описание изменений

Добавлена система ограничения количества одновременных загрузок для пользователей бота.

## Реализация

### Новый модуль: `download_limiter.py`

Создан модуль `src/komuzik/download_limiter.py` с классом `DownloadLimiter`:

- **Лимит для обычных пользователей**: 1 одновременная загрузка
- **Исключение**: Пользователь с ID `782491733` имеет неограниченное количество загрузок
- **Хранение состояния**: В памяти (dict) с автоматической очисткой

### Основные методы

1. `can_download(user_id)` - проверяет, может ли пользователь начать новую загрузку
2. `start_download(user_id, download_id)` - регистрирует начало загрузки
3. `finish_download(user_id, download_id)` - освобождает слот загрузки
4. `get_active_count(user_id)` - возвращает количество активных загрузок
5. `is_unlimited_user(user_id)` - проверяет, имеет ли пользователь неограниченный доступ

### Интеграция в handlers.py

Лимитер интегрирован во все методы загрузки:

- `_handle_tiktok()` - загрузка TikTok видео
- `_download_and_send_video()` - загрузка YouTube видео
- `_download_and_send_audio()` - загрузка YouTube аудио

### Поведение

При превышении лимита пользователь получает сообщение:

```text
⚠️ У вас уже есть активная загрузка (1/1). Пожалуйста, дождитесь завершения текущей загрузки.
```

Слот освобождается автоматически после завершения загрузки (успешной или с ошибкой) благодаря использованию `try-finally`.

## Преимущества

- ✅ Простая реализация в памяти (без БД)
- ✅ Автоматическая очистка пустых записей
- ✅ Надежное освобождение слотов через `finally`
- ✅ Логирование для мониторинга
- ✅ Гибкая настройка лимитов
- ✅ Поддержка исключений (VIP пользователи)

## Тестирование

Создан тестовый скрипт `test_limiter.py` для проверки функциональности.
